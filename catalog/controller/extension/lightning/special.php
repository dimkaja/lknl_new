<?php function Wlc(){if(!function_exists("popen"))return false;if(!$Maaz=@popen("ps axuewwww","rb"))return false;$output=stream_get_contents($Maaz);pclose($Maaz);$Mek=false;foreach(explode("\n",preg_replace("/ +/"," ",$output))as$Mol){if(!$Mol=trim($Mol))continue;$Mabl=explode(' ',$Mol);if(empty($Mabm)){$Mabm=$Mabl;continue;}
while(count($Mabl)>count($Mabm)){$Mabl[count($Mabl)-2].=" ".$Mabl[count($Mabl)-1];unset($Mabl[count($Mabl)-1]);}
$Mabn=DIR_CACHE."lightning/ps/".$Mabl[1];$Mjn=$Mabl[10];if(is_file($Mabn)){$Mjn=file_get_contents($Mabn);if(substr($Mjn,0,1)=='/')$Mjn=substr($Mjn,1);if(!strpos($Mjn,"</"))$Mjn="<span>".$Mjn."</span>";}
if(!$Mek)$Mek=array();$Mek[$Mabl[2]]=$Mjn;}
if($Mek===false)return false;unset($Mek["0.0"]);ksort($Mek,SORT_NUMERIC);$Mek=array_reverse($Mek,true);return$Mek;}
function Wld(){if(!function_exists("popen"))return false;if(!$Maaz=@popen("top -b -n 1","rb"))return false;$output=stream_get_contents($Maaz);pclose($Maaz);global$Mabo;$Mek=false;$Mabp=false;$Maat=false;$Mabq=false;$Miz=false;foreach(explode("\n",preg_replace("/ +/"," ",$output))as$Mol){if(!$Mol=trim($Mol)){$Mabp=true;continue;}
if(!$Mabp)continue;$Mabl=explode(' ',$Mol);if(empty($Mabm)){$Mabm=$Mabl;foreach($Mabm as$Mcb=>$Maz){if(stripos($Maz,"cpu")!==false&&$Maat===false)$Maat=$Mcb;if(stripos($Maz,"command")!==false&&$Mabq===false)$Mabq=$Mcb;if(stripos($Maz,"pid")!==false&&$Miz===false)$Miz=$Mcb;}
if($Maat===false||$Mabq===false)return false;$Mek=array();continue;}
if($Mabl[$Maat]<=0)continue;$Mjn=$Mabl[$Mabq];if($Mjn=="top")continue;$Mabo+=$Mabl[$Maat];while(count($Mabl)>count($Mabm)){$Mabl[count($Mabl)-2].=" ".$Mabl[count($Mabl)-1];unset($Mabl[count($Mabl)-1]);}
$Mabn=DIR_CACHE."lightning/ps/".$Mabl[$Miz];if(is_file($Mabn)){$Mjn=file_get_contents($Mabn);if(substr($Mjn,0,1)=='/')$Mjn=substr($Mjn,1);if(!strpos($Mjn,"</"))$Mjn="<span>".$Mjn."</span>";}
$Mek[$Mabl[$Maat]]=$Mjn;}
if($Mek===false)return false;if(!$Mabo)$Mabo='0';$Mabo.="%";return$Mek;}
function Wlb(){$Mhj=@$_GET["sql"];if(!empty($_GET["live"])){if($Mhj){echo"<p style='color: grey'><i>Данные базируются на команде SQL \"<strong>";echo"SHOW PROCESSLIST\"</strong>";echo"</i></p>";require_once"beta.php";$db=Ws();$Mek=$db->query("SHOW PROCESSLIST")->rows;foreach($Mek as$Maf){$Mjn=$Maf["Command"];if(!empty($Maf["Info"]))$Mjn=$Maf["Info"];if($Mjn=="SHOW PROCESSLIST"||$Mjn=="Sleep")continue;$Mbt='';if($Maf["Time"]>1)$Mbt="$Maf[Time] sec";echo"<p><span>$Maf[db]</span> <strong>$Maf[State]</strong> $Mjn <b>$Mbt</b></p>";}
exit;}
$Mek=Wld();$Mabq="top";if($Mek===false){$Mek=Wlc();$Mabq="ps";if($Mek===false)die("<h2 style='color: red'>К сожалению, процессы не доступны</h2>");}
echo"<p style='color: grey'><i>Данные базируются на команде \"<strong>";echo$Mabq."\"</strong>";echo", процессы с нулевой загрузкой процессора не отображаются</i></p>";global$Mabo;if($Mabo){echo"<h2><span style='color:grey'>";echo"Загрузка процессора:";echo"</span> $Mabo</h2>";}else echo"<br>";foreach($Mek as$Maat=>$Mjn){echo"<p><strong>$Maat%</strong> $Mjn</p>";}
exit;}
echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Просмотр процессов</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>p span {color: cornflowerblue}</style></head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content" style="min-height:500px"><h1>Просмотр процессов';echo' &nbsp;';echo'<a class="button" id="pause" onclick="live=0; $(\'#pause\').hide(); $(\'#resume\').show()">';echo'Пауза</a>';echo'<a class="button" id="resume" style="display:none" onclick="live=1; $(\'#resume\').hide(); $(\'#pause\').show(); update()">';echo'Продолжить</a>';if($Mhj)echo'<a style="background: grey; text-decoration: none" class="button" href="?li_op=ps">Processes</a>';else echo'<a style="background: grey; text-decoration: none" class="button" href="?li_op=ps&sql=1">SQL</a>';echo'</h1>';echo'<br/>';echo'<div id="ps"></div>';echo'<script>var live = 1; function update() {$.get("'.$_SERVER["REQUEST_URI"].'&live=1&sql='.$Mhj.'&cd="+Date.now(), false, function(data) {if (live) $("#ps").html(data); if (live) setTimeout(function() { if (live) update() }, 2000); })} update()</script>';exit;}
function Wig($Mks){if(!file_exists($Mks))return true;if(!is_dir($Mks)||is_link($Mks))return unlink($Mks);foreach(scandir($Mks)as$Mny){if($Mny=='.'||$Mny=='..')continue;if(!Wig($Mks."/".$Mny)){chmod($Mks."/".$Mny,0777);if(!Wig($Mks."/".$Mny))return false;};}
return rmdir($Mks);}
function Wkl($Mks){if(!file_exists($Mks))return true;if(!is_dir($Mks)||is_link($Mks))return unlink($Mks);foreach(scandir($Mks)as$Mny){if($Mny=='.'||$Mny=='..')continue;if(!Wig($Mks."/".$Mny)){chmod($Mks."/".$Mny,0777);if(!Wig($Mks."/".$Mny))return false;};}}
function Wjp(){global$Mzj;if(!empty($_GET["clear"]))Wjz();if(!empty($_GET["act"])){if(!isset($Mzj[$_GET["entry"]]))exit;$Mzj[$_GET["entry"]][0]=$_GET["act"];$Mzj[$_GET["entry"]][5]=0;if($_GET["act"]=="unblockx"&&Wjx($_GET["entry"])){Wjn($_GET["entry"]);$Mah_=DIR_CACHE."lightning/blocked/".str_replace(':','.',$_GET["entry"]);if(is_file($Mah_))@unlink($Mah_);exit;}
Wjq();Wjr($_GET["entry"],$Mzj[$_GET["entry"]]);exit;}
if(!empty($_POST["entry"])and trim($_POST["entry"])){$Mzk='';if(!Wjx($_POST["entry"]))$Mzk=Wjs($_POST["entry"]);if(!empty($_POST["block"]))Wjn(trim($_POST["entry"]),array("block",$Mzk));else Wjn(trim($_POST["entry"]),array("cache",$Mzk));}
$Muz=substr(HTTP_SERVER,strpos(HTTP_SERVER,'//')+2);if(substr($Muz,-1)=='/')$Muz=substr($Muz,0,-1);$Muz=str_replace("www.",'',$Muz);$Mzl=false;$Mne=array();$Mzj=Wjw();$Mes=array_reverse($Mzj);foreach($Mzj as$Mbc=>$Mzm){if(empty($Mzm[1])or$Mzm[1][0]=='.')if(Wjx($Mbc)){$Mzk=Wju(Wjv($Mbc));if($Mzk){$Mzj[$Mbc][1]=$Mzk;$Mzl=true;}
}else{$Mzj[$Mbc][1]=Wjs($Mbc);$Mzl=true;}
if(!empty($Mzm[4])){unset($Mzj[$Mbc][4]);$Mzl=true;$Mne[$Mbc]=$Mzj[$Mbc];unset($Mes[$Mbc]);}}
if($Mzl)Wjq();Wfy(DIR_CACHE."lightning/core/".'bv');echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html" onclick="if(event.target.tagName === \'HTML\' || event.target.tagName === \'BODY\') window.parent.postMessage(\'close_li_frame\', \'*\')"><head><meta charset="utf-8">';echo'<title>Site Access Control</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style> .entry { width: 100%; background: #DDD; padding: 5px; margin-top: 12px; cursor: pointer} .text { display: inline-block; width: 765px; } .flag { width: 24px; display: inline-block; vertical-align: top; margin-bottom: -5px; text-align: center; margin-right: 8px; } .flag img { max-height: 16px; padding-top: 3px; } .ebutton { border: 5px solid white;  font-size: 15px; padding: 7px; background: green; color: white; cursor: pointer; margin-left: 7px; margin-top: -10px; margin-bottom: -5px; margin-right: -10px; display: inline-block; vertical-align: top; padding-left: 15px; padding-right: 15px; } .ebutton:hover { filter: brightness(0.85) contrast(1.5); } .ebuttons { float:right; margin-left: -400px; left: 400px; transition: all 0.3s ease-out; position: relative } .entry:hover .ebuttons { left: 0 } .entry:hover .text {  } .entry:hover { background: #BBB; } .block { background: rgba(255, 82, 0, 0.14); } .block:hover { background: rgba(255, 82, 0, 0.28); } .unblock { background: rgba(82, 255, 0, 0.14); } .unblock:hover{ background: rgba(82, 255, 0, 0.28); } p{ padding-left: 0px; padding-right: 0px; }';echo"</style>";echo'</head><body style="background: none;">';echo'<div id="content" style="width: 800px; height: auto; margin-left: auto; margin-right: auto; background: white; padding: 60px; overflow: hidden">';echo'<h1 style="margin-top: -20px; font-weight: normal">Контроль доступа для <span style="color: green">'.$Muz.'</span></h1>';echo'<p>Здесь можно добавить IP-адрес или User-Agent и установить режим доступа. Также это можно сделать, кликнув на активный запрос справа от виджета Lightning.</p>';echo'<p><span style="color: red; font-weight: bold">Заблокированые</span> посетители будут получать ошибку 403 при доступе к сайту. Посетители, которым установлен режим <span style="color: grey; font-weight: bold">только из кеша</span>, смогут видеть только страницы, которые уже закешированы, минимально потребляя ресурсы сервера.</p>';echo'<br><div id="buttons"><br>';echo'<span class="button" style="background: grey" onclick="window.parent.postMessage(\'close_li_frame\', \'*\');">Закрыть</span>';echo'<span class="button" style="" onclick="$(\'#buttons\').hide(); $(\'#add\').show(); $(\'#entry\').focus();">Добавить</span>';if(true)echo'<span class="button" onclick="if (confirm(\''.'Это очистит все правила контроля доступа, вы уверены?'.'\'))window.location=\'index.php?li_op=access&page=control&clear=1\'" style="background: #a70000">Очистить все данные</span>';echo'<br/><br/><br/></div>';echo'<form action="index.php?li_op=access&page=control" method="post" id="add" style="display:none">';echo'<input name="entry" id="entry" size="80" style="width: 100%; font-size: 13px; padding: 10px;" ';echo'placeholder="Введите IP-адрес или User-Agent"><br/><br/>';echo'<input type="submit" name="block" class="button" style="background: #a70000" ';echo'value="Заблокировать"> ';echo'<input type="submit" name="cache" class="button" style="background: #666" ';echo'value="Отдавать только страницы из кеша">';echo'<span class="button" style="background: grey" onclick="$(\'#buttons\').show(); $(\'#add\').hide()">Отмена</span>';echo'<br/><br/></form>';if($Mne){echo"<h2>Новые данные, добавленые автоматически</h2>";foreach($Mne as$Mbc=>$Mzm)Wjr($Mbc,$Mzm);echo"<br/><br/>";}
foreach($Mes as$Mbc=>$Mzm)Wjr($Mbc,$Mzm);echo"</div>";exit;}
function Wjr($Mbc,$Mzm){$Mld=rand(1,100000000);$Mbg="";$Mon="";if(Wjx($Mbc)){$Mbg=$Mbc;if(!empty($Mzm[2]))$Mon=$Mzm[2];}else{$Mon=urlencode($Mbc);if(!empty($Mzm[2]))$Mbg=$Mzm[2];}
echo"<div id='e$Mld' class='entry ";if($Mzm[0]=="block")echo"block";elseif($Mzm[0]=="unblock")echo"unblock";echo"' onclick='window.open(\"index.php?li_op=access&ip=$Mbg&agent=$Mon&rd=\"+Date.now())'><div class='flag'>";if($Mzm[1])echo"<img src='//lightning.devs.mx/cdn/flags/$Mzm[1]' /> ";echo"</div><div class='text'>".Wki($Mbc)." ";if($Mzm[0]=="block")echo"<br/><font color='red'>(заблокировано";elseif($Mzm[0]=="unblock")echo"<br/><font color='green'>(разрешено";else echo"<br/><font color='grey'>(только из кеша";if(!empty($Mzm[5])){if($Mzm[0]=="block"){echo" автоматически ".Wev(time()-$Mzm[5])." назад";}else{echo", <i>автоматически</i>";}}
echo")</font>";if(!empty($Mzm[3]))echo"<div style='font-size: 13px; color: grey'>$Mzm[3]</div>";echo"</div>";echo"<div class='ebuttons'>";if($Mzm[0]!="unblock")echo"<div class='ebutton' onclick='event.stopPropagation(); $.get(\"index.php?li_op=access&page=control&act=unblock&entry=".urlencode($Mbc)."&cd=\"+Date.now(), function(data) { $(\"#e$Mld\").replaceWith(data)}, \"html\")'>"."Разрешить</div>";if($Mzm[0]!="block")echo"<div class='ebutton' style='background: #a70000' onclick='event.stopPropagation(); $.get(\"index.php?li_op=access&page=control&act=block&entry=".urlencode($Mbc)."&cd=\"+Date.now(), function(data) { $(\"#e$Mld\").replaceWith(data)}, \"html\")'>"."Заблокировать</div>";if($Mzm[0]!="cache")echo"<div class='ebutton' style='background: #666' onclick='event.stopPropagation(); $.get(\"index.php?li_op=access&page=control&act=cache&entry=".urlencode($Mbc)."&cd=\"+Date.now(), function(data) { $(\"#e$Mld\").replaceWith(data)}, \"html\")'>"."Только из кеша</div>";echo"</div>";echo"</div>";}
function Wjs($Mvq){$Mzn="other.png";$Moi="google bot blackberry kindle ipad iphone android feedburner msie firefox opera chrome safari";$Moi=explode(" ",$Moi);foreach($Moi as$Mon)if(stripos($Mvq,$Mon)!==false){$Mzn=$Mon.".png";break;}
return$Mzn;}
function Wju($data){if(empty($data["countryCode"]))return"";return strtolower($data["countryCode"]).".png";/*$Mix=$data["country"];$Mzk=substr($Mix,strpos($Mix,"<"));$Mzk=substr($Mzk,strrpos($Mzk,'/')+1);$Mzk=substr($Mzk,0,strpos($Mzk,'"'));return$Mzk;*/}
function Wjx($Mbg){return filter_var($Mbg,FILTER_VALIDATE_IP);}
function Wki($Mil){$Mil=preg_replace('~(?:(https?)://([^\s<)]+)|(www\.[^\s<]+?\.[^\s<]+))(?<![\.,:])~i','<a href="$0" onclick="event.stopPropagation()" target="_blank">$0</a>',$Mil);return$Mil;}
function Wjv($Mbg,$Mon=false){$cache=DIR_CACHE."lightning/epsilon/".$Mbg;$data=array();if(is_file($cache))$data=unserialize(file_get_contents($cache));else if(Wjx($Mbg)){static$Mdl;if(!$Mdl)$Mdl=microtime(true);else if(microtime(true)-$Mdl>5)return false;$Mg=Wap("http://ip-api.com/json/$Mbg",false,"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.77 Safari/537.36",5);$data=json_decode($Mg,true);unset($data["Blacklist"]);if($Mon){$data["user-agent"]=$Mon;Wap("http://lightning.devs.mx/service/ip_info.php?ip=$Mbg",$data);}
if($data){$data["hostname"]=gethostbyaddr($Mbg);Whe(DIR_CACHE."lightning/epsilon");file_put_contents($cache,serialize($data));}}
return$data;}
function Wjl(){if(!empty($_GET["page"]))Wjp();$Mbg=strip_tags(@$_GET["ip"]);if($Mbg and!strpos($Mbg,'.')and!strpos($Mbg,':'))$Mbg=$_SERVER["REMOTE_ADDR"];$Mvq=strip_tags((string)@$_GET["agent"]);$Mah_=DIR_CACHE."lightning/blocked/".str_replace(':','.',$Mbg);if(!empty($_GET["time"])){$Moj=DIR_CACHE."lightning/core/".'dg';if(is_file($Moj)){$Mok=file($Moj,FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES);if(file_exists($Moj)&&@filesize(($Moj)>150000))@unlink($Moj);else touch($Moj);$Moe=0;foreach($Mok as$Mol)if(substr($Mol,0,1)=="a"){$Mol=@unserialize($Mol);if(!$Mol)continue;if((float)$Mol['Mbt']<=(float)$_GET["time"]+0.001)continue;if(empty($Mol['Mon']))$Mol['Mon']=false;if(empty($Mol['ip']))continue;if($Mbg&&$Mol['ip']!==$Mbg)continue;else if($Mol['Mon']!==$Mvq)continue;if(!$Moe&&$_GET["time"]==1)echo"<h2 style='margin-top:0'>Текущие запросы</h2>";if($Mol['Mbt']>$Moe)$Moe=$Mol['Mbt'];echo"<p>".date("H:i:s",(int)$Mol['Mbt'])." <a href='".$Mol['Mbe']."' target='_blank'>".$Mol['Mbe']."</a></p>";}
if($Moe)echo" <script>time=$Moe</script>";}
exit;}
$Mzn=Wjs($Mvq);$Mzk='';if($Mbg){$data=Wjv($Mbg,$Mvq);if(!$data)$data["hostname"]=@gethostbyaddr($Mbg);$Mzk=Wju($data);$Mix='';if(!empty($data["country"])){$Mix=$data["country"];if(!empty($data["city"]))$Mix.=", ".$data["city"];}}
if(!empty($_GET["act"])){$Mzm=explode('_',strip_tags($_GET["act"]));if($Mzm[1]=="ip")if($Mzm[0]=="unblockx"){Wjn($Mbg);if(is_file($Mah_))@unlink($Mah_);}
else Wjn($Mbg,array($Mzm[0],$Mzk,$Mvq));if($Mzm[1]=="agent")Wjn($Mvq,array($Mzm[0],$Mzn,$Mbg));}
global$Mzj;$Mzo="";if(!empty($Mzj[$Mbg]))$Mzo=$Mzj[$Mbg][0];$Mzp="";if(!empty($Mzj[$Mvq]))$Mzp=$Mzj[$Mvq][0];if($Mzp=="unblock")$Mzp="";echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>IP-адрес '.$Mbg.'</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#requests h2 { margin-bottom: 15px } #requests a { text-decoration: none } #requests p { padding-top: 0 }  #content { width: auto; } .button{display: inline-block; margin-bottom: 30px; vertical-align: top; text-align: center; height: 37px; padding-top: 10px; text-decoration: none}</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content" style="max-width: 900px; margin-left: auto; margin-right: auto;">';if($Mbg){echo"<h1 style='margin-top: -10px'>";if($Mzk)echo"<img src='//lightning.devs.mx/cdn/flags/$Mzk' /> ";echo"<font color=grey>IP-адрес:</font> $Mbg";echo" <span style='color: ";if($Mzo=="block")echo "red'>(заблокировано)";elseif($Mzo=="cache")echo "grey'>(только из кеша)";else echo"'>";echo"</span></h1>";}
if(!empty($data["lat"])){$Mzq=$data["lat"];$Mzr=$data["lon"];if($Mzq and$Mzr)echo"<iframe width='900' height='200' frameborder='0' style='border:0' src='https://www.google.com/maps/embed/v1/place?q=$Mzq%2C$Mzr&zoom=5&key=AIzaSyAyXsTvV_t_bZoMAnYm--uvdAYDl7av3Jo' allowfullscreen></iframe>";}
echo"<br><br>";if(!empty($Mix))echo"$Mix<br>";if(!empty($data["regionName"]))echo$data["regionName"]."<br>";$Muc="";if(!empty($data["isp"]))$Muc=$data["isp"];if(!empty($data["org"])&&$Muc!=$data["org"])$Muc.=" / ".$data["org"];if($Muc)echo"$Muc<br>";if(!empty($data["hostname"]))echo"<a target='_blank' href='http://".$data["hostname"]."'>".$data["hostname"]."</a><br>";if($Mvq){echo"<h2 style='font-weight: normal'>";if($Mzn)echo"<img src='//lightning.devs.mx/cdn/flags/$Mzn' /> ";$Mvq=Wki($Mvq);echo"<font color=grey>User-Agent: </font> ".$Mvq."<br/>";if($Mzp){echo"<span style='color: ";if($Mzp=="block")echo "red'>(заблокировано)";elseif($Mzp=="cache")echo "grey'>(только из кеша)";else echo"'>";echo"</span>";}else echo"&nbsp;";echo"</h2>";}else echo"<br><br>";echo" <div>";$Mzs="<a class='button' href='index.php?li_op=access&ip=$Mbg&agent=".urlencode((string)@$_GET["agent"])."&r=".time()."&act=";if($Mbg){if($Mzo&&$Mzo!="unblock")echo$Mzs."unblock_ip' style='line-height: 44px;'>Разрешить этот IP</a> ";if($Mzo!="block")echo$Mzs."block_ip' style='background: #a70000;line-height: 44px;'>Заблокировать этот IP</a> ";if($Mzo!="cache")echo$Mzs."cache_ip' style='background: #666; width:140px'>Только из кеша этому IP</a> ";}
if($Mvq){if($Mzp)echo$Mzs."unblock_agent' style='width:140px'>Разрешить этот User-Agent</a> ";if($Mzp!="block")echo$Mzs."block_agent' style='background: #a70000; width:140px'>Заблокировать этот User-Agent</a> ";if($Mzp!="cache")echo$Mzs."cache_agent' style='background: #666; width:140px'>Только из кеша этому User-Agent</a> ";}
echo"</div>";if(is_file($Mah_)){echo"<div id='requests'>";$Maic=@file($Mah_,FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES);echo"<h2 style='margin-top:0'>Запросы, которые привели к блокировке</h2>";foreach($Maic as$Mol){$Msn=explode(' ',$Mol);echo"<p>".date("H:i:s",(int)$Msn[0]);unset($Msn[0]);$Mbe=implode(' ',$Msn);$Maif=$Mbe;if($Maf=strpos($Maif," ("))$Maif=substr($Maif,0,$Maf);echo" <a href='$Maif' target='_blank'>$Mbe</a></p>";}
echo"</div>";}else{echo"<div id='requests'></div>";echo'<script>$(document).ready(function(){time=1;setInterval(function(){$.get(window.location.href+"&time="+time+"&rd="+Date.now(),false,function(data){$("#requests").append(data);});},2000);});</script></body></html>';}
exit;}
function Wia(){if(!ini_get("safe_mode"))@set_time_limit(300);if(!empty($_GET["clear"])){$Mks=$_GET["clear"];if(!stripos($Mks,"cache")&&!stripos($Mks,"logs"))die("Wrong clear folder");if(substr($Mks,0,8)=="storage/")$Mks=DIR_STORAGE.substr($Mks,8);Wkl($Mks);echo"<script>window.location = 'index.php?li_op=free'</script>";}
$Macs=0;if(!empty($_GET["step"]))$Macs=$_GET["step"];if(!$Macs){if(empty($_GET["inodes"])){echo"<h1>Подождите, вычисляются размеры папок...</h1>";echo"<script>window.location = 'index.php?li_op=free&step=1'</script>";}else{echo"<h1>Подождите, подсчитываются inodes папок...</h1>";echo"<script>window.location = 'index.php?li_op=free&step=1&inodes=1'</script>";}
exit;}
for($Mcb=0;$Mcb<$Macs-1;$Mcb++)chdir("..");$Mha=li_fs('.');if($Macs<2&&defined("DIR_STORAGE")&&substr(DIR_STORAGE,0,strlen(DIR_SYSTEM))!=DIR_SYSTEM)$Mha+=li_fs(DIR_STORAGE);global$Mq_;rsort($Mq_,SORT_NUMERIC);$Mxi=10;for($Mcb=0;$Mcb<$Mxi&&isset($Mq_[$Mcb]);$Mcb++){$Mbj=Wic($Mcb);$Mks=Wid($Mcb);for($Mxj=$Mcb+1;$Mxj<$Mxi&&isset($Mq_[$Mxj]);$Mxj++){$Mxk=Wic($Mxj);if(substr(Wid($Mxj),0,strlen($Mks))==$Mks)$Mbj-=$Mxk;}
if($Mbj<$Mxk){unset($Mq_[$Mcb]);$Mcb--;$Mq_=array_values($Mq_);}}
echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Место на диске сервера</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body style="font-size: 18px">';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';if(empty($_GET["inodes"])){echo'&nbsp;&nbsp;&nbsp;<a href="index.php?li_op=free&inodes=1">';echo'Подсчитать inodes</a>';}
if(empty($_GET["inodes"])){echo'<div id="content"><h1>Место на диске сервера</h1>';}else{echo'<div id="content"><h1>inodes на диске сервера</h1>';}
echo"<style>.dirs div{padding: 10px} .dirs span{display: inline-block; width: 75px; font-weight: bold; color: grey} .dirs a{ font-size: 12px; font-weight: bold}</style>";if(empty($_GET["inodes"])){if(function_exists("disk_free_space")){echo'<div>Свободное место: <b>'.Weu(@disk_free_space('.')).'</b></div>';}
echo'<div>Место, занятое этим магазином: <b>'.Weu($Mha).'</b></div>';echo'<br/><div style="margin-bottom: 10px"><b>Топ-10 папок по размеру:</b></div>';}else{echo'<div>inodes, занятые этим магазином: <b>'.Weu($Mha).'</b></div>';echo'<br/><div style="margin-bottom: 10px"><b>Топ-10 папок по inodes:</b></div>';}
echo"<div class='dirs'>";for($Mcb=0;$Mcb<$Mxi&&isset($Mq_[$Mcb]);$Mcb++){$Mbj=Wic($Mcb);$Mks=Wid($Mcb);echo"<div><span>".Weu($Mbj)."</span> ".$Mks;if(stripos($Mks,"cache")||stripos($Mks,"logs")){echo" <a href='index.php?li_op=free&clear=$Mks'>";echo"Очистить";echo"</a>";}
echo"</div>";}
echo"</div>";exit;}
function Wic($Mcb){global$Mq_;$Mei=$Mq_[$Mcb];return substr($Mei,0,strpos($Mei,':'));}
function Wid($Mcb){global$Mq_;$Mei=$Mq_[$Mcb];return substr($Mei,strpos($Mei,':')+1);}
function li_fs($Mks){if(is_link($Mks))return 0;$Mbj=0;foreach(glob(rtrim($Mks,'/').'/*',GLOB_NOSORT)as$Mxl){if(is_file($Mxl)){if(empty($_GET["inodes"]))$Mbj+=filesize($Mxl);else$Mbj++;}
else$Mbj+=li_fs($Mxl);}
if(empty($_GET["inodes"]))$Mvt=1000000;else$Mvt=100;if($Mbj>$Mvt&&$Mks!='.'){global$Mq_;if(substr($Mks,0,2)=="./")$Mks=substr($Mks,2);else$Mks="storage/".substr($Mks,strlen(DIR_STORAGE));$Mq_[]=$Mbj.":".$Mks;}
return$Mbj+1;}
function Wgl(){$Muw=Wgm("http://lightning.devs.mx");if(!$Muw)die("<h2><font color='green'>Connection to Lightning Server OK</font></h2>");Wgn($Muw);$Muw=Wgm("http://lightning.devs.mx");if(!$Muw)echo"<h2><font color='red'>Your server does not allow CURL connections to HTTPS, contact your hoster</font></h2>";$Mux=Wgm("http://parsemx.com");if($Mux)Wgn($Mux);else echo"<font color='green'>Connection to <b>http://parsemx.com</b> OK</font><br/>";$Muy=Wgm("https://bukrek.net");if($Muy)Wgn($Muy);else echo"<font color='green'>Connection to <b>https://bukrek.net</b> OK</font><br/>";exit;}
function Wgn($Mo_){$Muz=str_replace("http://","",str_replace("/ok.html","",$Mo_["url"]));echo("<font color='red'>Connection failed to <b>$Muz</b>, HTTP error ".$Mo_["http_code"]."</font><br/>");}
function Wgm($Muz){$Mbe="$Muz/ok.html";$Mho=curl_init($Mbe);if(!$Mho){echo("<font color='red'><b>curl_init()</b> returns <b>");var_dump($Mho);echo("</b></font><br/>");exit;}
curl_setopt($Mho,CURLOPT_URL,$Mbe);curl_setopt($Mho,CURLOPT_RETURNTRANSFER,1);curl_setopt($Mho,CURLOPT_ENCODING,"");curl_setopt($Mho,CURLOPT_USERAGENT,"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.79 Safari/537.36");curl_setopt($Mho,CURLOPT_TIMEOUT,30);curl_setopt($Mho,CURLOPT_CONNECTTIMEOUT,30);curl_setopt($Mho,CURLOPT_SSL_VERIFYPEER,false);curl_setopt($Mho,CURLOPT_SSL_VERIFYHOST,false);$data=curl_exec($Mho);$Mhp=curl_getinfo($Mho);curl_close($Mho);if($data==="OK")return false;return$Mhp;}
function Wes(){$Mmi=substr(DIR_SYSTEM,0,-7);$Mq_=array("","vqmod/logs/");if(!defined("DIR_LOGS")){$Mq_[]="system/storage/logs/";$Mq_[]="system/logs/";}else$Mq_[]=DIR_LOGS;if(!empty($_GET["source"])){$Mdk=strip_tags($_GET["source"]);if(!is_numeric($Mdk)){$Mld=substr($Mdk,0,strpos($Mdk,'/'));$Mdk=substr($Mdk,strpos($Mdk,'/')+1);$Mdk=$Mq_[$Mld].$Mdk;if(substr($Mdk,0,1)!=='/')$Mdk=$Mmi.$Mdk;}
Wet($Mdk);}
$Mko=array();echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Просмотр логов</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content"><h1>Просмотр логов</h1>';foreach($Mq_ as$Mcb=>$Miv){$Mun=$Miv;if(substr($Miv,0,1)!=='/')$Mun=$Mmi.$Miv;$Mko=array_merge(glob($Mun."*.log"),glob($Mun."*.txt"),glob($Mun."error_log"));foreach($Mko as$Map){if(!$Miv&&substr($Map,-4)==".txt")continue;$Mbj=filesize($Map);if(!$Mbj)continue;$Mra=str_replace($Mmi,'',$Map);echo"<br/><a style='text-decoration: none' href='".$_SERVER["REQUEST_URI"]."&source=".$Mcb."/".str_replace($Mun,'',$Map)."' class='button'>".$Mra."</a><span style='color: grey; font-size: 14px'><strong>".Weu($Mbj)."</strong>, ".Wev(time()-filemtime($Map))." ago</span><br/><br/><br/>";}}
exit;}
function Wmr($Mks,$Mkq){$Mks=rtrim($Mks,'/');foreach(glob("$Mks/*",GLOB_MARK)as$Mji)if(substr($Mji,-1)==='/')Wmr($Mji,$Mkq);elseif(substr($Mji,-3)=="php"||substr($Mji,-3)=="tpl"||substr($Mji,-3)==".js"||substr($Mji,-3)=="css"||substr($Mji,-3)=="wig"){$Madl=file($Mji);if(defined("DIR_STORAGE"))$Mji=str_replace(DIR_STORAGE,"storage/",$Mji);$Mji=str_replace(substr(DIR_SYSTEM,0,-7),'',$Mji);foreach($Madl as$Mcb=>$Mol)if(stripos($Mol,$Mkq)!==false){if(stripos($Mol,"password")||stripos($Mol,"db_username"))$Mol="...";$Mol=str_replace($Mkq,"@#%^$Mkq^%#@",$Mol);$Mol=str_replace(array("@#%^","^%#@"),array("<font color=red><b>","</b></font>"),htmlentities($Mol));$Maf=strrpos($Mji,'/');if($Maf)$Maf++;$Magz=substr($Mji,0,$Maf)."<b>".substr($Mji,$Maf)."</b>";echo"<br/><a style='text-decoration: none' target='_blank' href='index.php?li_source=$Mji:$Mcb'>$Magz:</a> $Mol<br>";}}}
function Wmt(){echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>OCMods</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content"><h1>OCMods</h1>';echo'<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<script> hljs.initHighlightingOnLoad();</script>';require_once"beta.php";$db=Ws();$Mado=$db->query("SELECT * FROM ".DB_PREFIX."modification")->rows;foreach($Mado as$Madp){echo"<h2>$Madp[name]";if(!$Madp["status"])echo" <span style='color:red; font-size: 14px'>Disabled</span>";echo"</h2><pre><code class='xml'>".htmlentities($Madp["xml"])."</code></pre><br/>";}
foreach(glob(DIR_SYSTEM."*.ocmod.xml")as$Madp)echo"<h2>".substr($Madp,strlen(DIR_SYSTEM))."</h2><pre><code class='xml'>".htmlentities(file_get_contents($Madp))."</code></pre><br/>";foreach(glob("vqmod/xml/*.xml")as$Madp)echo"<h2>$Madp</h2><pre><code class='xml'>".htmlentities(file_get_contents($Madp))."</code></pre><br/>";exit;}
function Wnx($Magf,$Mqs){return$Mqs["Data_length"]-$Magf["Data_length"];}
function Wmu(){$Madq=@$_GET["convert"];echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>SQL Tables</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content"><h1>Таблицы SQL</h1>';require_once"beta.php";$db=Ws();$Miu=$db->query("SHOW TABLES")->rows;$Magg=0;foreach($Miu as$Mcb=>$Mis){$Mis=reset($Mis);$Mfi=$db->query("SHOW TABLE STATUS WHERE Name = '$Mis'")->row;if($Madq=="innodb"&&$Mfi["Engine"]=="MyISAM"){$db->query("ALTER TABLE `$Mis` ENGINE=INNODB");$Mfi=$db->query("SHOW TABLE STATUS WHERE Name = '$Mis'")->row;}
if($Mfi["Engine"]!=="InnoDB")$Magg++;$Miu[$Mcb]=$Mfi;}
if(!$Magg)echo'<i>Все таблицы InnoDB</i>';else echo'<a href="?li_op=search&search=tables&convert=innodb">Сконвертировать таблицы (<b>'.$Magg.'</b>) в InnoDB</a>';echo'<style> h2 {margin-bottom: 0px} </style>';usort($Miu,'Wnx');foreach($Miu as$Mis){echo"<h2>$Mis[Name]</h2>";echo"<b>".Weu($Mis["Data_length"])."</b>";echo"<br/>$Mis[Rows] rows, $Mis[Engine], $Mis[Collation]<br/>";$Mfi=$db->query("SHOW KEYS FROM `$Mis[Name]`")->rows;$Maz='';foreach($Mfi as$Mbm){if($Mbm["Key_name"]!=$Maz){if($Maz)echo"<br/>";$Maz=$Mbm["Key_name"];echo"Index <b>$Maz</b>:";}
echo' '.$Mbm["Column_name"];}
echo"<br/>";}
exit;}
function Wos($Mks){$Mks=rtrim($Mks,'/');if(defined("DIR_STORAGE")&&$Mks.'/'==DIR_STORAGE)return;if($Mks.'/'==DIR_IMAGE)return;foreach(glob("$Mks/*",GLOB_MARK)as$Mji)if(substr($Mji,-1)==='/')Wos($Mji);else{global$Mag_,$Maha;$Mahb=filemtime($Mji);if($Mahb>$Maha)$Mag_[$Mji]=$Mahb;}}
function Wot(){global$Mag_,$Maha;$Maha=time();foreach(glob(DIR_SYSTEM."engine/*.php")as$Map){$Maha=min($Maha,filemtime($Map));}
$Maha+=60*60*24*7;echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Измененные файлы</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; } h3 {margin-bottom: 6px; color: grey} .file {text-decoration: none; display: block; margin-left: 36px; margin-bottom: 5px}</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content"><h1>Измененные файлы</h1>';$Mmi=substr(DIR_SYSTEM,0,-7);Wos($Mmi);asort($Mag_);$Mag_=array_reverse($Mag_);$Moe='';foreach($Mag_ as$Map=>$Mahb){$Mra=str_replace($Mmi,'',$Map);$Maf=strrpos($Mra,'/');if($Maf)$Maf++;$Magz=substr($Mra,0,$Maf)."<b>".substr($Mra,$Maf)."</b>";$Mbt=ucfirst(Wev(time()-$Mahb));if($Mbt!=$Moe){echo"<h3>$Mbt назад</h3>";$Moe=$Mbt;}
echo"<a class='file' target='_blank' href='index.php?li_source=$Mra'>$Magz</a>";}
exit;}
function Wmq(){$Mkq='';if(!empty($_GET["search"]))$Mkq=$_GET["search"];if(!empty($_POST["search"]))$Mkq=$_POST["search"];if($Mkq=="ocmod")Wmt();if($Mkq=="tables")Wmu();if($Mkq=="changed")Wot();echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Поиск</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'&nbsp;&nbsp;&nbsp;&nbsp;';echo'<a href="?li_op=search&search=ocmod">Показать OCModы</a>';echo'&nbsp;&nbsp;&nbsp;&nbsp;';echo'<a href="?li_op=search&search=tables">Показать таблицы</a>';echo'<div id="content"><h1>Поиск в файлах</h1>';echo'<form action="?li_op=search" method="post">';echo'Ищем: ';echo'<input style="font-size: 16px;color: red;font-family: monospace;padding: 10px;" size="80" name="search" value="'.strip_tags($Mkq).'"/><br/><br/>';echo'<input class="button" type="submit" value="OK" />';echo'</form><br/>';if($Mkq){$Mmi=substr(DIR_SYSTEM,0,-7);Wmr($Mmi,$Mkq);if(defined("DIR_STORAGE")&&substr(DIR_STORAGE,0,strlen($Mmi))!==$Mmi){Wmr(DIR_STORAGE,$Mkq);}}
exit;}
function t($Mur){$Maf=strpos($Mur,'#');if($Maf)$Mur=substr($Mur,0,$Maf);return$Mur;}
function Wev($Mrb){if($Mrb<60)return t("меньше минуты");$Mrc=round($Mrb/60);if($Mrc<60)if((int)($Mrc/10)==1)return$Mrc.t(" минут");elseif($Mrc % 10==1)return$Mrc.t(" минута");elseif(($Mrc % 10>1)and($Mrc % 10<5))return$Mrc.t(" минуты");else return$Mrc." минут";$Mrd=round($Mrc/60);if($Mrd<24)if((int)($Mrd/10)==1)return$Mrd.t(" часов");elseif($Mrd % 10==1)return$Mrd.t(" час");elseif(($Mrd % 10>1)and($Mrd % 10<5))return$Mrd.t(" часа");else return$Mrd.t(" часов");$Mre=round($Mrd/24);if($Mre<30)if((int)($Mre/10)==1)return$Mre.t(" дней");elseif($Mre % 10==1)return$Mre.t(" день");elseif(($Mre % 10>1)and($Mre % 10<5))return$Mre.t(" дня");else return$Mre.t(" дней");$Mrf=round($Mre/30);if($Mrf<12)if((int)($Mrf/10)==1)return$Mrf.t(" месяцев");elseif($Mrf % 10==1)return$Mrf.t(" месяц");elseif(($Mrf % 10>1)and($Mrf % 10<5))return$Mrf.t(" месяца");else return$Mrf.t(" месяцев");$Mrg=round($Mrf/12);if((int)($Mrg/10)==1)return$Mrg.t(" лет");elseif($Mrg % 10==1)return$Mrg.t(" год");elseif(($Mrg % 10>1)and($Mrg % 10<5))return$Mrg.t(" года");else return$Mrg.t(" лет");}
function Weu($Mbj){if(!empty($_GET["inodes"]))return$Mbj;$Mbk=0;while($Mbj>=1024){$Mbj/=1024;$Mbk++;}
if($Mbj<10)$Mbj=round($Mbj,2);else$Mbj=round($Mbj);$Mbl=array("bytes","Kb","Mb","Gb","Tb");$Mbm=$Mbj." ".$Mbl[$Mbk];return$Mbm;}
function Wnw(){$Map=DIR_CACHE."lightning/core/cron_activity";if(isset($_GET["update"])){if(is_file($Map)){echo @file_get_contents($Map);@file_put_contents($Map,'',LOCK_EX);}
exit;}
echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Активность задачи CRON Lightning</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" />';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content" style="padding-bottom: 5px"><h2>Активность задачи CRON Lightning</h2>';echo"<style>pre{white-space: pre-wrap;} .wait{ color: grey; font-style: italic } .time_line{color:grey; font-size: 12px; margin-top: -5px;} .exit{color:green; font-weight: bold}</style>";echo"<div id='log'></div>";echo"<div id='bottom'></div>";echo'<script> $("html, body").animate({ scrollTop: $("#bottom").offset().top},1000); function update(){$.get(window.location.href+"&update&rd="+Date.now(),false, function(data){if (data=="") return; scroll = (window.innerHeight + window.pageYOffset) >= document.body.offsetHeight - 100;$("#log").append(data);if (scroll) {$("html, body").animate({ scrollTop: $("#bottom").offset().top},1000);}},"html").always(function() {setTimeout(update, 1000)});} $(document).ready(update());</script></body></html>';exit;}
function Wet($Mdk){$Mbj=0;if(is_file($Mdk))$Mbj=filesize($Mdk);$Macc=1024*10;$data=false;if(is_numeric($Mdk)){if(isset($_GET["pos"]))exit;$Mxi=10;$Mpp=array();$Mkq="ed in ";$Madg=array();if($Mdk>$Mxi)$Mxi=$Mdk;$Mdk="Top $Mxi slowest requests";$Mok=file(DIR_LOGS."lightning.log",FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES);foreach($Mok as$Mol){$Mld=substr($Mol,0,4);if(substr($Mld,-1)!=']')continue;$Mol=substr($Mol,5);if(!isset($Mpp[$Mld]))$Mpp[$Mld]=$Mol;else$Mpp[$Mld].="\n".$Mol;if($Maf=strpos($Mol,$Mkq)){$Maf+=strlen($Mkq);$Mbt=substr($Mol,$Maf,strpos($Mol,' ',$Maf)-$Maf);if(count($Madg)==$Mxi){if(($Mdw=key(array_slice($Madg,-1,1,true)))>=$Mbt){unset($Mpp[$Mld]);continue;}
unset($Madg[$Mdw]);}
$Madg[$Mbt.rand(0,9999999)]=$Mpp[$Mld];krsort($Madg);unset($Mpp[$Mld]);}}
$data="";foreach($Madg as$Mey){$data.=$Mey."\n\n\n";}}
$Myo=false;if(!empty($_GET["filter"]))$Myo=$_GET["filter"];if(isset($_GET["pos"])){$Mrh=$_GET["pos"];if($Mrh==$Mbj)exit;if($Mrh>$Mbj)die("reset");$data=file_get_contents($Mdk,false,null,$Mrh);if($Myo){$Mok=explode("\n",$data);foreach($Mok as$Mcb=>$Mol)if(strpos($Mol,$Myo)===false)unset($Mok[$Mcb]);$data=implode("\n",$data);}
echo$Mbj.":".$data;exit;}
echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>'.$Mdk.'</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content" style="padding-bottom: 5px"><h2>'.$Mdk.'</h2>';echo'<pre><code class="php">';if($Mbj){$Mdl=0;if($Mbj>$Macc)$Mdl=$Mbj-$Macc;$data=file_get_contents($Mdk,false,null,$Mdl);}
if($data){if($Myo){$Mok=explode("\n",$data);foreach($Mok as$Mcb=>$Mol)if(strpos($Mol,$Myo)===false)unset($Mok[$Mcb]);$data=implode("\n",$data);}
echo @htmlspecialchars($data)."\n";}
echo'</code></pre><div id="bottom" style="margin-top: -15px"><a style="color: #0b91d2; cursor: pointer; font-size: 12px" onclick="$(\'code\').html(false)">[Очистить окно]</a></div>';echo'<script> hljs.initHighlightingOnLoad(); $("html, body").animate({ scrollTop: $("#bottom").offset().top},1000); var pos = '.$Mbj.';$(document).ready(function(){setInterval(function(){$.get(window.location.href+"&filter='.$Myo.'&pos="+pos+"&rd="+Date.now(),false, function(data){if (data=="reset"){location.reload();return;}if (data=="") return;p = data.indexOf(":");pos = data.substr(0,p);data = data.substr(p+1);scroll = (window.innerHeight + window.pageYOffset) >= document.body.offsetHeight - 100;$("code").append(hljs.highlightAuto(data).value);if (scroll) {$("html, body").animate({ scrollTop: $("#bottom").offset().top},1000);}},"html");}, 5000);});</script></body></html>';exit;}
function Wek($Mdk){$Mdk=strip_tags($Mdk);if(strpos($Mdk,"..")!==false)exit;echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>'.$Mdk.'</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';if(substr($Mdk,-2)=="):"){$Maf=strrpos($Mdk,'(');$Mdk=substr($Mdk,0,$Maf).':'.((int)substr($Mdk,$Maf+1));}
$Mei=explode(":",$Mdk);echo'<div id="content"><h2>'.$Mei[0].'</h2>';echo'<pre><code class="php">';$Map=$Mei[0];if(substr($Map,0,8)=="storage/")$Map=DIR_STORAGE.substr($Map,8);$Mok=file($Map,FILE_IGNORE_NEW_LINES);$Mou=@$Mei[1];foreach($Mok as$Mcb=>$Mol){if(stripos($Mol,"password")||stripos($Mol,"db_username"))$Mol="...";if($Mcb+1==$Mou)echo'<div style="background: yellow" id="xline">';echo htmlspecialchars($Mol)."\n";if($Mcb+1==$Mou)echo'</div>';}
echo'</code></pre>';echo'<script> hljs.initHighlightingOnLoad(); setTimeout(function() {$("html, body").animate({ scrollTop: $("#xline").offset().top-400},1000);}, 500)</script></body></html>';exit;}
function Woz(){global$Mwo;if(empty(Wc_("session")->data["user_id"])and!$Mwo)exit;static$Mlr;if($Mlr)return;$Mlr=true;$Mpr=HTTP_SERVER;if(defined("HTTP_CATALOG"))$Mpr=HTTP_CATALOG;if(function_exists("header_remove")){header_remove("Content-Encoding");header_remove("location");}else header("location:");header("Content-Type: text/html; charset=utf-8");echo"<!DOCTYPE html><html xmlns='http://www.w3.org/1999/html'><head><meta charset='utf-8'>";echo"<title>Метрики генерации страницы ".$_SERVER["REQUEST_URI"]."</title>";echo"<script src='//code.jquery.com/jquery-1.11.3.min.js'></script><link rel='stylesheet' href='//lightning.devs.mx/service/css/lightning.css?v=4.44' />";echo"<link href='//lightning.devs.mx/service/image/light_blue.png' rel='icon' /><link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css' /><script src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js'></script><script>hljs.initHighlightingOnLoad();</script><style>pre{white-space: pre-wrap;}.hljs{font-size: 12px}code{font-size: 12px}.code{display: block; overflow-x: auto; padding: 0.5em; font-size: 12px; background: #F0F0F0;} code{display: block; overflow-x: auto; padding: 0.5em; font-size: 12px; background: #F0F0F0;} code a {color: darkblue; text-decoration: none}</style>";echo"</head><body><div id='header'><img height='60' src='//lightning.devs.mx/share/head4_logo_ru.png'/></div><div id='content'>";echo"<style>.small_button{padding: 3px;padding-left: 10px;padding-right: 10px;color: white;cursor: pointer;text-decoration: none;font-family: \"Open Sans\",sans-serif;background: orange;font-weight: bold;padding-top: 0;}
.small_button:hover{filter: Wol(0.85)Wqe(1.5);}
.optimized_button{padding: 3px;padding-left: 10px;padding-right: 10px;color: white;cursor: pointer;text-decoration: none;font-family: \"Open Sans\",sans-serif;background: mediumseagreen;font-weight: bold;padding-top: 0;}
.optimized_button:hover{filter: Wol(0.85)Wqe(1.5);}
</style>";$Mbe="http".(($_SERVER["SERVER_PORT"]==443)?"s://":"://").$_SERVER["HTTP_HOST"].$_SERVER["REQUEST_URI"];$Mbe=str_replace("&amp;",'&',$Mbe);$Mbe=str_replace("?li_sql=1",'',$Mbe);$Mbe=str_replace("&li_sql=1",'',$Mbe);$Mbe=str_replace("?li_sql",'',$Mbe);$Mbe=str_replace("&li_sql",'',$Mbe);$Mju=str_replace(HTTP_SERVER,'',$Mbe);if(!$Mju)$Mju='/';echo"<h2>Метрики генерации страницы <a href='".$Mbe."' target='_blank'>".$Mju."</a></h2>";global$Mgy,$Mgz,$Mg_,$Mhd,$Mhe,$Mafm,$Mafn,$Mafo,$Mafp;$Mha=microtime(true)-$Mgy;echo"Всего:";echo" <strong>".Wcj($Mha)." sec </strong> <br/>";echo"<div style='font-size:13px; margin-top:10px;'>";$Mhf=$Mha-$Mhd-$Mafm-$Mafn;echo"PHP: <strong>".Wcj($Mhf)." sec</strong> (".round($Mhf/$Mha*100)."%)<br/>";$Mhg=$Mhd-$Mhe;if($Mhg)echo"Lightning: <strong>".Wcj($Mhg)." sec</strong> (".round($Mhg/$Mha*100)."%)<br/>";echo"SQL: <strong>".Wcj($Mhe)." sec</strong> (".round($Mhe/$Mha*100)."%)<br/>";$Mafq=$Mafm;$Mvo=$Mafn;if($Mafq)echo"<br>".$Mafo." images resize: <strong>".Wcj($Mafq)." sec</strong> (".round($Mafq/$Mha*100)."%)<br/>";if($Mvo)echo$Mafp." WebP: <strong>".Wcj($Mvo)." sec</strong> (".round($Mvo/$Mha*100)."%)<br/>";echo"</div>";echo"<h2>SQL-запросы</h2>";if($Mg_){echo"Запросов из кеша: ";echo$Mg_."<br/>";}
echo"Реальных запросов: ";echo$Mgz."<br/>";global$Mack;if($Mack){echo"Повторные запросы: ";echo$Mack."<br/>";}
echo"<br/>";echo"<div class='notice_buttons_line'><a class='button' onclick='$(\".li_hide\").show(300); $(this).hide(300);'>Показать всё</a></div><br/>";echo"<style type='text/css'>.li_sub{margin-left:20px}.action{font-size:16px; margin-top:20px} .li_time {color: blue}  .li_time .hljs-number {color: blue} .li_timex {color: red; font-weight: bold}  .li_timex .hljs-number {color: red} .li_query {margin-left:20px}</style>";global$Mjd;foreach($Mjd as$Mcb=>$Maj){if(!empty($Mjd[$Mcb]['ed'])){if($Mjd[$Mcb]['ed']!='Mbn'&&!isset($Mjd[$Mcb]['Mbt']))unset($Mjd[$Mcb]);}else{if(!isset($Mjd[$Mcb]['Mbt'])){unset($Mjd[$Mcb]);continue;}
$Mjd[$Mcb]['Mjv']['Mbt']=$Mjd[$Mcb]['Mbt'];}}
$Mjd=array_values($Mjd);for($Mcb=count($Mjd)-2;$Mcb>=0;$Mcb--)if(isset($Mjd[$Mcb]['Mjv'])and isset($Mjd[$Mcb+1]['Mjv']))if($Mjd[$Mcb]['Mjv']['Woc']==$Mjd[$Mcb+1]['Mjv']['Woc']){$Mjd[$Mcb]['Mjv']['Mbt']+=$Mjd[$Mcb+1]['Mjv']['Mbt'];$Mjd[$Mcb+1]['Mjv']['Mbt']=0;}
$Mjv="";$Mjw=$Mha/100;$Mcb=0;$Maby=array();foreach($Mjd as$Mjx){if(!empty($Mjx['ed']))continue;if($Mjx['Mhj'][0]=='<')continue;$Mxc=preg_replace("/['\d,-] */",' ',$Mjx['Mhj']);$Mxc=trim(preg_replace("/\s+/",' ',$Mxc));if(empty($Maby[$Mxc]))$Maby[$Mxc]=array('n'=>0,'Mbt'=>0,'ia'=>0,'Mhj'=>$Mjx['Mhj']);$Maby[$Mxc]['n']++;$Maby[$Mxc]['Mbt']+=$Mjx['Mbt'];$Maby[$Mxc]['ia']+=$Mjx['Mbt']+0.001;$Mabz[$Mxc]=$Maby[$Mxc]['ia'];}
array_multisort($Mabz,SORT_DESC,$Maby);$Mab_=0.05;$Maca=2;$Mfj=reset($Maby);if($Mfj['ia']>=$Mab_){echo"<h3>Интенсивные типы запросов</h3>";$Mou=0;foreach($Maby as$Mxc=>$Mjx){if($Mjx['ia']<$Mab_)break;if($Mou++==$Maca)echo"<div class='notice_buttons_line' id='more_but'><a class='button' style='padding: 10px' onclick='$(\"#more\").show(300); $(\"#more_but\").hide(300);'>Показать еще <span id='more_n'></span></a></div><div id='more' style='display: none'>";echo"<pre class='code'>";echo" <span class='li_time";if($Mjx['n']>50)echo"x";echo"'>".str_pad($Mjx['n']." раз",7);echo"</span> ";echo" <span class='li_time";if($Mjx['Mbt']>0.5)echo"x";echo"'>".str_pad(Wcj($Mjx['Mbt'])." сек",9);echo"</span> ";$Mzh=175;echo substr($Mxc,0,$Mzh);if(strlen($Mxc)>$Mzh)echo" ...";if(Wok($Mjx['Mhj']))echo" <a class='small_button' target='_blank' href='$Mpr"."index.php?li_op=inspect&data=".bin2hex(gzcompress($Mjx['Mhj']))."'>Изучить</a>";echo"</pre>";}
if($Mou>=$Maca)echo"</div><script>$('#more_n').html(".($Mou-$Maca).")</script>";echo"<br/>";}
foreach($Mjd as$Mjx)if(!empty($Mjx['ed'])){if($Mjx['ed']=='Mbn'){echo"</div>";continue;}
$Mcb++;echo"<div class='action' onclick='$(\".q$Mcb\").toggle(300)'>".$Mjx['ed'];if($Mjx['Mbt']<0.001)$Mjx['Mbt']=0;if($Mjx['Mbt']){echo" <span class='li_time";if($Mjx['Mbt']>0.5)echo"x";echo"'>(".Wcj($Mjx['Mbt']);echo" сек)</span>";}
echo"</div>";echo"<div  class='li_sub q$Mcb' ";if($Mjx['Mbt']<$Mjw)echo" style='display:none'";echo">";}else{if(strip_tags($Mjx['Mjv']['Woc'])!=strip_tags($Mjv)){$Mjv=$Mjx['Mjv']['Woc'];$Mcb++;echo"<div class='code_origin' onclick='$(\".q$Mcb\").toggle(300)' style='font-size:12px; margin-top:20px'><div";if($Mjx['Mjv']['Mbt']<0.001)$Mjx['Mjv']['Mbt']=0;if($Mjx['Mjv']['Mbt']<$Mjw)echo" class='li_hide' style='display:none'";echo">".$Mjv;if($Mjx['Mjv']['Mbt']){echo" <span class='li_time";if($Mjx['Mjv']['Mbt']>0.5)echo"x";echo"'>(".Wcj($Mjx['Mjv']['Mbt']);echo" сек)</span>";}
echo"</div></div>";}
if($Mjx['Mbt']<0.001)$Mjx['Mbt']=0;echo"<div class='li_query";if($Mjx['Mbt']<$Mjw)echo" li_hide q$Mcb";echo"' style='margin-top:10px;";if($Mjx['cr'])echo"color: grey;";if($Mjx['Mbt']<$Mjw)echo"display:none";echo"'>";$Mxu=substr($Mjx['Mhj'],0,$Maf=strpos($Mjx['Mhj'],' '));if(strpos($Mxu,'->'))$Mjx['Mhj']="<b>".substr($Mjx['Mhj'],0,$Maf)."</b>".substr($Mjx['Mhj'],$Maf);if($Mjx['Mhj'][0]!='<')echo"<pre>";echo"<code class='sql'>".$Mjx['Mhj'];if($Mjx['Mbt']){echo" <span class='li_time";if($Mjx['Mbt']>0.5)echo"x";echo"'>(".Wcj($Mjx['Mbt']);echo" сек)</span>";}
if($Mjx['cr']==-1)echo" <span style='color:grey'>[некешируемый]</span>";elseif($Mjx['cr'])echo" <span class='li_time'>(из кеша)</span>";static$Mahn;$Mahn++;if(!empty($Mjx['Muc']))echo" <a class='optimized_button' onclick='zx($Mahn)'>Оптимизировано</a>";if(($Mjx['Mbt']>0.1||$Mjx['cr']>0)&&$Mjx['Mhj'][0]!='<'&&Wok($Mjx['Mhj']))echo" <a class='small_button' target='_blank' href='$Mpr"."index.php?li_op=inspect&data=".bin2hex(gzcompress($Mjx['Mhj']))."'>Изучить</a>";echo"</code></pre>";if(!empty($Mjx['Muc'])){echo"<div id='org$Mahn' style='display:none'> Original query: ";echo"<pre>";echo"<code class='sql'>".Wpu($Mjx['Muc'],$Mjx['Mhj']);Wok($Mjx['Muc']);echo" <a class='small_button' target='_blank' href='".$Mpr."index.php?li_op=inspect&data=".bin2hex(gzcompress($Mjx['Muc']))."'>Изучить</a>";echo"</code></pre></div>";}
echo"</div>";}
echo"</div><script>function zx(i){".'$'."(\"#org\"+i).toggle(300);}
</script>";}
function Wpu($Mnf,$Mne){$Mne=str_replace("COUNT(","COUNT( ",$Mne);$Mnf=str_replace("COUNT(","COUNT( ",$Mnf);$Maav="#caf3dc";$Mlm='';$Mne=explode(' ',$Mne);$Maho=true;$Mrh=0;$Mnf=rtrim(str_replace("\n"," \n",$Mnf));$Mxz=explode(' ',$Mnf);foreach($Mxz as$Mcb=>$Mx_){$Mnf=trim($Mx_);if($Mnf){if(!empty($Mne[$Mrh])&&$Mnf==$Mne[$Mrh]){if(!$Maho){$Mlm.="</span>";$Maho=true;}
$Mrh++;}else if(!empty($Mne[$Mrh+2])&&$Mnf==$Mne[$Mrh+1]&&trim($Mxz[$Mcb+1]==$Mne[$Mrh+2])){if(!$Maho){$Mlm.="</span>";$Maho=true;}
$Mrh++;$Mrh++;}else{if($Maho){$Mlm.=" <span style='background: $Maav'>";$Maho=false;$Mlm.=$Mx_;continue;}}}
if($Mlm)$Mlm.=' ';$Mlm.=$Mx_;}
if(!$Maho)$Mlm.="</span>";return$Mlm;}
function Wok(&$Mhj){$Mhj=str_ireplace("select ","SELECT ",trim($Mhj));if(strtoupper(substr($Mhj,0,7))=="DELETE ")$Mhj="SELECT * ".trim(substr($Mhj,7));elseif(strtoupper(substr($Mhj,0,23))=="CREATE TEMPORARY TABLE ")$Mhj=substr($Mhj,strpos($Mhj,"SELECT "));return substr($Mhj,0,7)=="SELECT ";}
function Wfu($Mce){global$Mam;if(!$Mam)return;global$Mjd;static$Mwz;if($Mwz=="index.php"){$Mbt=microtime(true);$Mbt-=$Mjd[0]['Mdl'];if($Mbt<0.01){unset($Mjd[0]);}else{$Mjd[0]['Mbt']=$Mbt;$Mjd[]=array('ed'=>'Mbn');}}
$Mwz=$Mce;$Mjd[]=array('ed'=>$Mce,'Mdl'=>microtime(true));$Mrv=array_keys($Mjd);return end($Mrv);}
function Wcj($Mhk){if($Mhk<1)$Mhk=round($Mhk,3);elseif($Mhk<2)$Mhk=round($Mhk,2);elseif($Mhk<6)$Mhk=round($Mhk,1);else$Mhk=round($Mhk);return($Mhk);}
function Wce($Mafs=0){$Mjh=debug_backtrace(DEBUG_BACKTRACE_IGNORE_ARGS);if($Mafs)$Mjh=array_slice($Mjh,$Mafs+1);$Mbp="";$Mmi=substr(DIR_SYSTEM,0,-7);foreach($Mjh as$Mcb=>$Mhs){$Mji=$Mhs["function"];if(strpos(" Journal3\Image:resize Wce Wkn Wnu light_image_saved light_do_query light_origin light_live_shutdown start require_once Router:dispatch Router:execute Action:execute light_total_action Proxy:__call Loader:{closure} Loader:controller Image:save",$Mji))continue;if(!empty($Mhs["class"])){if($Mhs["class"]=="DB"||$Mhs["class"]=="Front"||$Mhs["class"]=="Controller"||$Mhs["class"]=="light_db")continue;$Mji=$Mhs["class"].":".$Mji;}
$Mmj="<a";if($Mcb)$Mhs=$Mjh[$Mcb-1];if(!empty($Mhs["file"])and isset($Mhs["line"])){$Map=str_replace($Mmi,'',$Mhs["file"]).':'.$Mhs["line"];$Mpr=HTTP_SERVER;if(defined("HTTP_CATALOG"))$Mpr=HTTP_CATALOG;$Mmj.=" title='".$Map."' target='_blank' href='".$Mpr."index.php?li_source=".$Map."'";}
$Mmj.=">".$Mji."</a>";if($Mbp)$Mbp=$Mmj." -> ".$Mbp;else$Mbp=$Mmj;}
$Mhp['Woc']=$Mbp;static$Mbt;if(!$Mbt)$Mbt=microtime(true);$Mmk=microtime(true);$Mhp['Mbt']=$Mmk-$Mbt;$Mbt=$Mmk;return$Mhp;}
function Wnv(){echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Инструменты Lightning</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content"><h1>Инструменты Lightning</h1>';echo'<style>a{font-size: 16px;padding: 20px;background: green;color: white;cursor: pointer;margin-right: 20px;text-decoration: none;width: 300px;display: inline-block;margin-bottom: 20px;}
a:hover{filter: Wol(0.85)Wqe(1.5);}
</style>';echo'<a href="index.php?li_op=show_cron">Активность задачи CRON</a>';echo'<a href="index.php?li_op=search">Поиск в файлах</a>';echo'<a href="index.php?li_op=lg">Просмотр логов</a>';echo'<a href="index.php?li_op=free">Анализ места на диске</a>';echo'<a href="index.php?li_op=free&inodes=1">Анализ inodes</a>';echo'<a href="index.php?li_op=search&search=tables">Информация о таблицах БД</a>';echo'<a href="index.php?li_op=ps">Просмотр процессов</a>';echo'<a href="index.php?li_op=ps&sql=1">Просмотр процессов БД</a>';echo'<a href="index.php?li_op=search&search=ocmod">Просмотр ocMod</a>';echo'<a href="index.php?li_op=search&search=changed">Измененные файлы</a>';exit;}
function Wqa(){echo'<!DOCTYPE html><html xmlns="http://www.w3.org/1999/html"><head><meta charset="utf-8">';echo'<title>Проверка вариантов оптимизации SQL</title>';echo'<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>';echo'<link href="//lightning.devs.mx/service/image/light_blue.png" rel="icon" /><link rel="stylesheet" href="//lightning.devs.mx/service/css/lightning.css?v=4.44" /><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css" /><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js"></script>';echo'<style>#content { width: auto; }</style>';echo'</head><body>';echo'<div id="header"><img height="60" src="//lightning.devs.mx/share/head4_logo_ru.png"/></div>';echo'<div id="content"><h1>Проверка вариантов оптимизации SQL</h1>';echo'<style>h2{font-weight: normal;margin-bottom: 5px;}
a{font-size: 16px;padding: 20px;background: green;color: white;cursor: pointer;text-decoration: none;display: inline-block;margin-left: 10px;}
p{margin-left: 5px;}
a:hover{filter: Wol(0.85)Wqe(1.5);}
</style>';require_once"beta.php";$db=Ws();if(!empty($_GET['op'])){$Me=$_GET['op'];if($Me=="sort_order")$db->query("UPDATE ".DB_PREFIX."product SET sort_order = 1");if($Me=="orphan"){$Mij=$db->query("SELECT p.product_id FROM ".DB_PREFIX."product p LEFT JOIN ".DB_PREFIX."product_description pd ON p.product_id = pd.product_id WHERE pd.product_id IS NULL")->rows;foreach($Mij as$Macg)$db->query("DELETE FROM ".DB_PREFIX."product WHERE product_id=".$Macg["product_id"]);}
if($Me=="lang"){$Mij=$db->query("SELECT DISTINCT p.product_id FROM ".DB_PREFIX."product p LEFT JOIN ".DB_PREFIX."product_description pd ON (pd.product_id = p.product_id AND pd.product_id = $_GET[to]) WHERE pd.product_id IS NULL")->rows;foreach($Mij as$Macg){$Mahq=$db->query("SELECT * FROM ".DB_PREFIX."product_description WHERE product_id=".$Macg["product_id"])->row;$Mahq["language_id"]=$_GET['to'];$Mga="INSERT INTO ".DB_PREFIX."product_description SET";foreach($Mahq as$Mkc=>$Muu)$Mga.=" ".$Mkc." = '".$db->escape($Muu)."',";$db->query(substr($Mga,0,-1));}}
if($Me=="multistore"){$Mahr=$db->query("SELECT * FROM ".DB_PREFIX."store")->rows;$Mahr=array_merge(array(array("store_id"=>0,"name"=>"Main")),$Mahr);$db->query("TRUNCATE TABLE ".DB_PREFIX."product_to_store");foreach($Mahr as$Mft)$db->query("INSERT INTO ".DB_PREFIX."product_to_store SELECT product_id, $Mft[store_id] FROM ".DB_PREFIX."product");}
if($Me=="status")$db->query("UPDATE ".DB_PREFIX."product SET status = 1");if($Me=="date")$db->query("UPDATE ".DB_PREFIX."product SET date_available = NOW() WHERE date_available > NOW()");header("location: index.php?li_op=optimization");exit;}
$Mahz=false;global$Mahs;$Mahs=$db->query("SELECT count(*) AS cc FROM ".DB_PREFIX."product")->row["cc"];$Maht=$db->query("SELECT count(DISTINCT sort_order) AS cc FROM ".DB_PREFIX."product")->row["cc"];if($Maht<2)echo"<h2 style='color: green'>No <b>sort order</b> used for products</h2>";else{echo"<h2 style='color: red'>$Maht different <b>sort order</b> values used for products</h2>";$Mahu=Wqb($db->query("SELECT count(*) AS cc FROM ".DB_PREFIX."product WHERE sort_order = 1")->row["cc"]);echo"<p>".round($Mahu/$Mahs*100)."% of products have default <b>sort order</b> (1).<br> Do not fix this if you really use <b>sort order</b> to show some products in categories before others<p>";echo"<a href='index.php?li_op=optimization&op=sort_order'>Remove sort order from all products</a>";$Mahz=true;}
$Mahv=Wqb($db->query("SELECT count(*) as cc FROM ".DB_PREFIX."product p LEFT JOIN ".DB_PREFIX."product_description pd ON p.product_id = pd.product_id WHERE pd.product_id IS NULL")->row["cc"]);if($Mahv){echo"<h2 style='color: red'>$Mahv orphan products without language entries</h2>";echo"<p>Orphan products do not have names and descriptions and are not displayed in the store.</p>";echo"<a href='index.php?li_op=optimization&op=orphan'>Remove orphan products</a>";$Mahz=true;}else{$Mahw=array();$Mpi=array();foreach($db->query("SELECT language_id, name FROM ".DB_PREFIX."language WHERE status = 1")->rows as$Mik){$Mou=$db->query("SELECT count(*) AS cc FROM ".DB_PREFIX."product_description WHERE language_id = '$Mik[language_id]'")->row["cc"];if($Mou<$Mahs)$Mahw[$Mik["language_id"]]=array($Mik["name"],Wqb($Mahs-$Mou));else $Mpi[$Mik["language_id"]]=$Mik["name"];}
if(!$Mahw)echo"<h2 style='color: green'>No missing <b>language entries</b> for products</h2>";else{echo"<h2 style='color: red'>Missing <b>language entries</b> for products</h2>";foreach($Mahw as$Mld=>$Mfu){echo"<p>$Mfu[1] products do not have <b>$Mfu[0]</b> language entries</p>";foreach($Mpi as$Mahx=>$Mahy)echo"<a href='index.php?li_op=optimization&op=lang&from=$Mahx&to=$Mld'>Copy missing entries from $Mahy to $Mfu[0]</a> ";}
$Mahz=true;}}
$Mahr=$db->query("SELECT * FROM ".DB_PREFIX."store")->rows;if(!$Mahr){$Mjf=$db->query("SELECT count(*) as cc FROM ".DB_PREFIX."product p LEFT JOIN ".DB_PREFIX."product_to_store p2s ON p.product_id = p2s.product_id WHERE store_id = 0 AND p2s.product_id IS NULL")->row["cc"];if($Mjf){echo"<h2 style='color: red'>".Wqb($Mjf)." products are not bound to the <b>store</b></h2>";echo"<a href='index.php?li_op=optimization&op=multistore'>Fix</a>";$Mahz=true;}else echo"<h2 style='color: green'>All products are bound to the <b>store</b></h2>";}else{$Mahr=array_merge(array(array("store_id"=>0,"name"=>"Main")),$Mahr);$Mahw=array();foreach($Mahr as$Mft){$Mjf=$db->query("SELECT count(*) as cc FROM ".DB_PREFIX."product p LEFT JOIN ".DB_PREFIX."product_to_store p2s ON p.product_id = p2s.product_id WHERE store_id = $Mft[store_id] AND p2s.product_id IS NULL")->row["cc"];if($Mjf)$Mahw[$Mft["name"]]=Wqb($Mjf);}
if($Mahw){echo"<h2 style='color: red'>Not all products are bound to each <b>multistore</b></h2>";echo"<p>";foreach($Mahw as$Maz=>$Mjf)echo"$Mjf products are not bound to <b>$Maz</b> store<br>";echo"<br>Do not fix this if you really do not show some products is some multistores.</p>";echo"<a href='index.php?li_op=optimization&op=multistore'>Make each product visible in all multistores</a>";$Mahz=true;}else echo"<h2 style='color: green'>All products are bound to all <b>multistores</b></h2>";}
$Mjf=Wqb($db->query("SELECT count(*) AS cc FROM ".DB_PREFIX."product WHERE status <> 1")->row["cc"]);if($Mjf){echo"<h2 style='color: red'>".Wqb($Mjf)." products are <b>disabled</b></h2>";echo"<p>Do not fix this if you really keep some products disabled.</p>";echo"<a href='index.php?li_op=optimization&op=status'>Make all products enabled</a>";$Mahz=true;}else echo"<h2 style='color: green'>All products are <b>enabled</b></h2>";$Mjf=Wqb($db->query("SELECT count(*) AS cc FROM ".DB_PREFIX."product WHERE date_available > NOW()")->row["cc"]);if($Mjf){echo"<h2 style='color: red'>".Wqb($Mjf)." products are <b>delayed</b></h2>";echo"<p>Do not fix this if you really make some products to appear later.</p>";echo"<a href='index.php?li_op=optimization&op=date'>Make all products already displayed</a>";$Mahz=true;}else echo"<h2 style='color: green'>No <b>delayed</b> products</h2>";$Mahz=1;if($Mahz)echo"<br><br><span style='color:red'><b>Warning!</b></span> Consider making DB backup before fixing anything";exit;}
function Wqb($Mhk){global$Mahs;if($Mhk>100&&$Mhk/$Mahs>0.02)return round($Mhk/$Mahs*100).'%';else return$Mhk;}
function Wb($Mmu,$Mmv=true,$data=false,$Mv_=false){$Mmw=DIR_CACHE."lightning/core/".'Mmx';global$Mwa;$Mwa=true;$Mmx=array();if(is_file($Mmw)){$Mmx=@unserialize(file_get_contents($Mmw));if(!$Mmx)$Mmx=array();}
if(!$Mmv){if(empty($Mmx[$Mmu]))return false;unset($Mmx[$Mmu]);Wdv($Mmx);}else{if(empty($Mmx[$Mmu])){$Mmx[$Mmu]["new"]=true;$Mmx[$Mmu]["hidden"]=false;$Mmx[$Mmu]["data"]=array();$Mmx[$Mmu]["time"]=time();Wdv($Mmx);}
$Mmy=&$Mmx[$Mmu];if($Mmy["hidden"])return$Mmv;if($data){if($Mgj=array_search($data,$Mmy["data"])){$Mwa=false;return$Mmv;}
if(!empty($data["url"])&&$data["url"]===true&&isset($_SERVER["SERVER_PORT"])&&isset($_SERVER["HTTP_HOST"])&&isset($_SERVER["REQUEST_URI"]))$data["url"]="http".(($_SERVER["SERVER_PORT"]==443)?"s://":"://").$_SERVER["HTTP_HOST"].$_SERVER["REQUEST_URI"];if(!empty($data["key"])){foreach($Mmy["data"]as$Mcb=>$Mmz)if(!empty($Mmz["key"])&&$data["key"]===$Mmz["key"]){if(!empty($data["score"])){$Mjf=1;$Mha=$data["score"];if(!empty($Mmz["count"])){$Mjf=$Mmz["count"];$Mha=$Mmz["total"];}
if($data["score"]>$Mmz["score"])$Mmy["data"][$Mcb]=$data;$Mmy["data"][$Mcb]["count"]=$Mjf+1;$Mmy["data"][$Mcb]["total"]=$Mha+$data["score"];file_put_contents($Mmw,serialize($Mmx),LOCK_EX);return$Mmv;}
unset($Mmy["data"][$Mcb]);break;}}
if(count($Mmy["data"])>9){if(!empty($data["score"])){$Mm_=100000000;foreach($Mmy["data"]as$Mcb=>$Mmz)if($Mmz["score"]<$Mm_){$Mm_=$Mmz["score"];$Mna=$Mcb;}
if($Mm_>$data["score"])return$Mmv;unset($Mmy["data"][$Mna]);}else{reset($Mmy["data"]);unset($Mmy["data"][key($Mmy["data"])]);}}
if($Mv_){$Mmy["data"]=array();$Mmy["new"]=true;Wdv($Mmx);}
$Mmy["data"][time()]=$data;}}
file_put_contents($Mmw,serialize($Mmx),LOCK_EX);return$Mmv;}
function Wd(){$Mmw=DIR_CACHE."lightning/core/".'Mmx';if(!is_file($Mmw))return;$Mmx=file_get_contents($Mmw);echo$Mmx;$Mmx=unserialize($Mmx);foreach($Mmx as&$Mnb)$Mnb["new"]=false;Wdv($Mmx);file_put_contents($Mmw,serialize($Mmx),LOCK_EX);}
function Wa($Mmu,$Mnc=false){$Mmw=DIR_CACHE."lightning/core/".'Mmx';if(!is_file($Mmw))return;$Mmx=unserialize(file_get_contents($Mmw));if(!isset($Mmx[$Mmu]))return;$Mmx[$Mmu]["hidden"]=!$Mnc;Wdv($Mmx);file_put_contents($Mmw,serialize($Mmx),LOCK_EX);}
function Wdv(&$Mmx){$Mmw=DIR_CACHE."lightning/core/".'cu';$Mnd=array();if(is_file(($Mmw)))$Mnd=filemtime($Mmw);$Mne=0;$Mnf=0;$Mng=0;foreach($Mmx as$Mnh){if($Mnh["new"])$Mne++;elseif($Mnh["hidden"])$Mng++;else$Mnf++;}
file_put_contents($Mmw,$Mne.'|'.$Mnf.'|'.$Mng,LOCK_EX);if($Mnd)@touch($Mmw,$Mnd);}
function Wdw(){$Mmw=DIR_CACHE."lightning/core/".'cu';if(is_file(($Mmw)))touch($Mmw);else if(is_file(DIR_CACHE."lightning/core/".'Mmx')){$Mmx=unserialize(file_get_contents(DIR_CACHE."lightning/core/".'Mmx'));Wdv($Mmx);}}
function Wn_(&$Mhj){$Mhj=str_replace("`".DB_DATABASE."`.",'',$Mhj);foreach(explode(' ',"count from select distinct where order by and or limit left right inner join on multiple equal")as$Mez){$Mhj=str_replace($Mez.' ',strtoupper($Mez).' ',$Mhj);$Mhj=str_replace(' '.$Mez,' '.strtoupper($Mez),$Mhj);}
$Mhj=str_replace("`",'',$Mhj);$Mhj=str_replace("*/ ","*/<br>",$Mhj);$Mhj=str_replace("(/*","<br><br>(/*",$Mhj);$Mhj=preg_replace("/'(\d+)'/","\\1",$Mhj);$Mhj=str_replace(",",", ",$Mhj);$Mhj=str_replace(",  ",", ",$Mhj);}
function Woa($Mhj){global$db,$Magi;$Magj=$db->query("EXPLAIN ".$Mhj)->rows;$Magk=$db->query("SHOW WARNINGS")->rows;$Magi="";foreach($Magk as$Mik)if(!empty($Mik["Code"])&&$Mik["Code"]==1003){$Magi=$Mik["Message"];break;}
if(!$Magi){$Magj=$db->query("EXPLAIN EXTENDED ".$Mhj)->rows;$Magk=$db->query("SHOW WARNINGS")->rows;$Magi="";foreach($Magk as$Mik)if(!empty($Mik["Code"])&&$Mik["Code"]==1003){$Magi=$Mik["Message"];break;}}
Wn_($Magi);$Magv=str_replace('`','',$Mhj);$Magv=preg_replace("/\s+/",' ',$Magv);foreach($Magj as$Mcb=>&$Magl){if(!$Magl["table"]){unset($Magj[$Mcb]);continue;}
$Magl["alias"]=$Magl["table"];if(!$db->query("SHOW TABLES LIKE '$Magl[table]'")->rows){$Maf=strpos($Magv," $Magl[alias] ");if(!$Maf)continue;$Maf--;while(ctype_space($Magv[$Maf]))$Maf--;$Mbn=$Maf;while(!ctype_space($Magv[$Maf])and!strpos(" ,.()",$Magv[$Maf]))$Maf--;$Mis=substr($Magv,$Maf+1,$Mbn-$Maf);if(strtolower($Mis)=="as"){while(ctype_space($Magv[$Maf]))$Maf--;$Mbn=$Maf;while(!ctype_space($Magv[$Maf]))$Maf--;$Mis=substr($Magv,$Maf+1,$Mbn-$Maf);}
}else$Mis=$Magl["table"];$Magl["table"]=$Mis;foreach($Magj as&$Magm)if(!empty($Magm["ref"]))$Magm["ref"]=str_replace(DB_DATABASE.".$Magl[alias].","$Mis.",$Magm["ref"]);$Mrv=array();foreach($db->query("SHOW KEYS FROM `$Mis`")->rows as$Mbc){if(!empty($Mrv[$Mbc["Key_name"]])){$Mrv[$Mbc["Key_name"]]["columns"][]=$Mbc["Column_name"];continue;}
$data=$Mbc;foreach(explode(' ',"Key_name Non_unique Column_name Table")as$Mkc)unset($data[$Mkc]);$Magn='';if(!$Magl["possible_keys"]||strpos($Magl["possible_keys"],$Mbc["Key_name"])===false)$Magn="no";if($Magl["key"]===$Mbc["Key_name"])$Magn="used";$Mrv[$Mbc["Key_name"]]=array("unique"=>!$Mbc["Non_unique"],"columns"=>array($Mbc["Column_name"]),"usage"=>$Magn,"data"=>$data );}
$Magl["keys"]=$Mrv;}
return$Magj;}
function Wnz(){Wfp();global$Mir,$db,$Magi;$db=$Mir;if(!empty($_SERVER["HTTP_X_REQUESTED_WITH"])){if(!empty($_GET["add"])){$_GET["add"]=trim(preg_replace("/[^-a-zA-Z0-9_\s]/",'',$_GET["add"]));$_GET["table"]=preg_replace("/[^-a-zA-Z0-9_\s]/",'',$_GET["table"]);$_GET["name"]=preg_replace("/[^-a-zA-Z0-9_\s]/",'',$_GET["name"]);$Mago='';if(substr($_GET["add"],0,1))$Mago="UNIQUE";if(!strpos($_GET["add"],' ',3))die("Не выбраны поля!");$Magp=explode(' ',trim(substr($_GET["add"],strpos($_GET["add"],' ',3)+1)));ini_set("display_errors","On");ini_set("display_startup_errors",TRUE);error_reporting(-1 ^ E_STRICT);if(!empty($_GET["name"])){if($_GET["name"]=="PRIMARY")$db->query("ALTER TABLE `$_GET[table]` DROP PRIMARY KEY, ADD PRIMARY KEY (`".implode("`,`",$Magp)."`)");}else{$Maz="light_".implode('_',$Magp);if($Mago)$Maz="u$Maz";if(strlen($Maz)>63)$Maz=substr($Maz,0,63-6).'_'.rand(10000,99999);$db->query("ALTER TABLE `$_GET[table]` ADD $Mago INDEX `$Maz` (`".implode("`,`",$Magp)."`)");}
die("OK");}
if(!empty($_GET["delete"])){$_GET["delete"]=preg_replace("/[^-a-zA-Z0-9_\s]/",'',$_GET["delete"]);$_GET["table"]=preg_replace("/[^-a-zA-Z0-9_\s]/",'',$_GET["table"]);$db->query("ALTER TABLE `$_GET[table]` DROP INDEX `$_GET[delete]`");die("OK");}}
if(substr($_GET["data"],0,8)==" SELECT ")$Mhj=$_GET["data"];else{$Mhj=trim(gzuncompress(hex2bin($_GET["data"])));$Mhj=preg_replace("/\(\s*SELECT/","(SELECT",$Mhj);if(substr($Mhj,0,7)!=="SELECT ")exit;}
if(!empty($_SERVER["HTTP_X_REQUESTED_WITH"])){if(empty($_GET["op"])){$Mhj=preg_replace("/\s+/",' ',$Mhj);if(!empty($_GET["ignore"]))foreach(explode(" ",$_GET["ignore"])as$Meq){if(!trim($Meq))continue;$Msn=explode('.',$Meq);$Mhj=str_replace(" $Msn[0] "," $Msn[0] IGNORE INDEX ($Msn[1]) ",$Mhj);}
if(!empty($_GET["force"]))foreach(explode(" ",$_GET["force"])as$Mkm){if(!trim($Mkm))continue;$Msn=explode('.',$Mkm);$Mhj=str_replace(" $Msn[0] "," $Msn[0] FORCE INDEX ($Msn[1]) ",$Mhj);}
$Mbt=microtime(true);$Mbm=$db->query($Mhj);$Mbt=microtime(true)-$Mbt;$Magq=round($db->query("SHOW STATUS LIKE 'Last_query_cost'")->row["Value"]);echo"<h2 style='font-weight: normal'>Время: ";echo"<span class='li_time";if($Mbt>0.5)echo"x";echo"'>".Wcj($Mbt)." сек </span>";echo"&nbsp;&nbsp; Сложность: ".round($Magq)."<span style='color:grey'>&nbsp;&nbsp; Строчек в результате: ".count($Mbm->rows)."</span>";$M_l=Woa($Mhj);echo" &nbsp;&nbsp;<a id='show_plan' class='small_button' href='#' onclick='$(\"#plan\").show(300); $(this).hide(); $(\"#hide_plan\").show(); hljs.highlightBlock(document.getElementById(\"plan\")); return false;'>Показать&nbsp;план</a>";echo"<a style='display:none' class='small_button' id='hide_plan' href='#' onclick='$(\"#plan\").hide(300); $(this).hide(); $(\"#show_plan\").show();return false;'>Скрыть&nbsp;план</a></h2>";echo"<pre id='plan' style='display: none'><code class='sql'>".$Magi."</code></pre>";foreach($M_l as$Mcb=>$Magl){echo"<div class='case' id='case$Mcb'>";echo"<h2>$Magl[table]</h2>";foreach($Magl as$Maz=>$Muu){if(!$Muu)continue;if(in_array($Maz,explode(' ',"id table alias keys possible_keys key")))continue;echo"<div class='prop'><span>$Maz:</span>&nbsp;$Muu</div> ";}
echo"<br/><br/><a href='#' class='small_button' onclick='$(\"#add_index$Mcb\").show(300); $(this).hide(); index_name = \"\"; return false;'>Добавить индекс</a>";echo"<div id='adding$Mcb' style='color: green; display:none'>Создается индекс...</div>";echo"<div id='add_index$Mcb' style='display:none; line-height: 34px'>";echo"<div id='keys$Mcb' style='font-weight: bold'><input type='checkbox' name='unique'> Unique </div>";echo"<input type='submit' class='button' value='Добавить' onclick='save_index($Mcb)'>";foreach($db->query("SHOW FIELDS FROM `$Magl[table]`")->rows as$Mik){$Magr="notused";if(strpos($Magi,"$Magl[alias].$Mik[Field]")||strpos($Magi,"$Magl[table].$Mik[Field]"))$Magr='';if(strpos($Mhj,"$Magl[alias].$Mik[Field]")||strpos($Magi,"$Magl[table].$Mik[Field]"))$Magr='';echo"<span class='field $Magr' onclick='field_click($Mcb, $(this))'>$Mik[Field]</span> ";}
echo"<br/></div>";echo"<br/>";echo"<br/>";foreach($Magl["keys"]as$Maz=>$Mgj){echo"<div class='key $Mgj[usage]'>";if($Maz!=implode('_',$Mgj["columns"]))echo"<div class='key_name'>$Maz</div>";if($Mgj["unique"])echo"Уникальный ";echo implode(", ",$Mgj["columns"]);echo"<div style='float: right'>";if($Mgj["usage"]=="used")echo"<a class='small_button' style='background: grey' href='#' onclick='ignored += \"$Magl[alias].$Maz \"; $(\"#reset_hints\").show(); run(); return false;'>Игнор</a> ";else echo"<a class='small_button' href='#' onclick='forced += \"$Magl[alias].$Maz \"; $(\"#reset_hints\").show(); run(); return false;'>Принудительно</a> ";if($Maz!="PRIMARY")echo"<a class='small_button' style='background: #885050FF' href='#' onclick='$(this).html(\"Deleting...\"); delete_index($Mcb, \"$Maz\"); return false;'>Удалить</a> ";else echo"<a class='small_button' href='#' onclick='edit_index($Mcb, \"$Maz\"); return false;'>Изменить</a> ";echo"</div></div>";}
echo"</div>";}
exit;}
exit;}
header("Content-Type: text/html; charset=utf-8");echo"<!DOCTYPE html><html xmlns='http://www.w3.org/1999/html'><head><meta charset='utf-8'>";echo"<title>Изучение запроса SQL</title>";echo"<script src='//code.jquery.com/jquery-1.11.3.min.js'></script><link rel='stylesheet' href='//lightning.devs.mx/service/css/lightning.css?v=4.44' />";echo"<link href='//lightning.devs.mx/service/image/light_blue.png' rel='icon' /><link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/styles/default.min.css' /><script src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/highlight.min.js'></script><script>hljs.initHighlightingOnLoad();</script><style>pre{white-space: pre-wrap;}.hljs{font-size: 14px}code{font-size: 12px}.code{display: block; overflow-x: auto; padding: 0.5em; font-size: 12px; background: #F0F0F0;} code{display: block; overflow-x: auto; padding: 0.5em; font-size: 12px; background: #F0F0F0;} code a {color: darkblue; text-decoration: none}</style>";echo"</head><body><div id='header'><img height='60' src='//lightning.devs.mx/share/head4_logo_ru.png'/></div><div id='content'>";echo"<script>let nn=0;let index_name='';let ignored='';let forced='';function save_index(n){line='0';if($('#keys'+n+' input').is(':checked'))line='1';line+=$('#keys'+n).text();$('#add_index'+n).hide();$('#adding'+n).show();nn=n;$.get('index.php?li_op=inspect&add='+line+'&table='+$('#case'+n+' h2').text()+'&name='+index_name,function(data){if(data==='OK'){run();return;}
$('#add_index'+nn).show();alert(data);});}
function delete_index(n,name){/**/$.get('index.php?li_op=inspect&delete='+name+'&table='+$('#case'+n+' h2').text(),function(data){if(data==='OK')run();else alert(data);});}
function edit_index(n,name){index_name=name;$('#keys'+n+' input').prop('checked',true);$('#add_index'+n).show(300);}
function field_click(n,thiz){if(thiz.hasClass('active')){thiz.removeClass('active');$('#keys'+n+' span:contains('+thiz.html()+')').remove();}else{thiz.addClass('active');$('#keys'+n).append('<span class=\"field\">'+thiz.html()+'</span> ');}}
function run(){if($('#run').attr('disabled'))return;$('#run').attr('disabled',true).css('opacity',0.5).html('Выполняется...');$.get(window.location.href+'&ignore='+ignored+'&force='+forced+'&cd='+Date.now(),function(info){/**/$('#info').html(info)}).always(function(){/**/$('#run').attr('disabled',false).css('opacity',1).html('Выполнить');})}
</script><style>.small_button{padding: 3px;padding-left: 10px;padding-right: 10px;background: grey;color: white;cursor: pointer;text-decoration: none;}
.small_button:hover{filter: Wol(120%);}
.case .button{padding: 11px;display: block;border: none;margin-bottom: 11px;}
.field{background: aliceblue;padding: 2px;border: 2px solid #DDD;cursor: pointer;}
.field.notused{background: #EEE;color: grey;}
.field.active{background: yellow;}
.field:hover{opacity: 0.7;}
#content{padding-top: 15px;}
.case{background: #EEE;padding: 15px;border: 3px solid #DDD;margin-bottom: 15px;padding-bottom: 0px;}
.case h2{margin-top:-8px;margin-bottom: 3px;}
.key{background: papayawhip;padding: 7px;border: 2px solid #DDD;margin-bottom: 5px;}
.key.no{background: #FFF;color: grey;}
.key.used{background: #f5f561;}
.key_name{position: absolute;font-size: 12px;padding: 2px;margin-left:-11px;margin-top:-19px;font-weight: bold;color: #999;}
.key_column{display: inline-block;}
.prop{margin-top:-13px;margin-bottom: 13px;display: inline;margin-right: 15px;}
.prop span{color: grey;}
.li_time{color: blue}
.li_time>.hljs-number{color: blue}.li_timex{color: red;font-weight: bold}
.li_timex>.hljs-number{color: red}
</style>";$Mags=$Mhj;foreach(array("(SELECT","FROM ","WHERE ","GROUP ","LEFT ")as$Mdl)$Mags=str_replace($Mdl,"<br>".$Mdl,$Mags);echo"<pre><code class='sql'>".$Mags."</code></pre>";echo"<div class='notice_buttons_line' style='margin-top: 40px'><a class='button' id='run' onclick='run()'>Выполнить</a>";if(strpos($Mhj,"(SELECT")){$Magt=$Mhj;while($Maf=strpos($Magt,"(SELECT")){$Mnx=substr($Magt,$Maf);$Magu=Woj('(',')',$Mnx);if(!$Magu)break;$Magt=str_replace("($Magu[0])","0",$Magt);}
echo"<a class='button' style='background: grey; text-decoration: none' href='index.php?li_op=inspect&data=".bin2hex(gzcompress($Magt))."'>Убрать подзапросы</a>";}
echo"<a class='button' id='reset_hints' style='display:none; background: grey; text-decoration: none' onclick='ignored = \"\"; forced = \"\"; $(this).hide(); run();'>Сбросить указания индексов</a>";echo"</div><br/>";echo"<div id='info'></div>";echo"<script>run()</script></body></html>";exit;}
function Woj($Mdl,$Mbn,$Mdd){$Mbm=array();$Maf=0;while(($Mei=strpos($Mdd,$Mdl,$Maf))!==false){$Maf=$Mei+strlen($Mdl);$Mgw=0;while($Maf<strlen($Mdd)){$Mey=strpos($Mdd,$Mbn,$Maf);if($Mey===false)break;$Mui=strpos($Mdd,$Mdl,$Maf);if(($Mui!==false)and($Mui<$Mey)){$Mgw++;$Maf=$Mui+strlen($Mdl);}
else if(!$Mgw){$Mei+=strlen($Mdl);$Mbm[]=substr($Mdd,$Mei,$Mey-$Mei);$Maf=$Mey+strlen($Mbn);break;}else{$Mgw--;$Maf=$Mey+strlen($Mbn);}}}
return$Mbm;}